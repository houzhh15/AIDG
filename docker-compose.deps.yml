services:
  # Whisper 转录服务
  whisper:
    image: ghcr.io/mutablelogic/go-whisper:latest
    container_name: aidg-whisper
    ports:
      - "8082:80"
    volumes:
      - ./models/whisper:/data
      - ./data/meetings:/output
    networks:
      - aidg-network
    restart: unless-stopped
    # 注意：whisper 容器可能需要较长启动时间
    # 如果健康检查持续失败，可以临时移除 healthcheck 或调整为更宽松的配置
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 6G  # large-v3 模型需要 ~3GB + 运行时开销
        reservations:
          cpus: '1'
          memory: 3G  # 预留 3GB 确保模型加载

  # Command Executor Service (FFmpeg + PyAnnote)
  deps-service:
    build:
      context: .
      dockerfile: Dockerfile.deps
    image: aidg-deps-service:latest
    container_name: aidg-deps-service
    volumes:
      - ./data:/app/data  # 修改挂载路径为 /app/data，与 commands.yaml 的 shared_volume_path 一致
      - ./config:/app/config:ro  # 挂载整个 config 目录（与 build-deps-service.sh 一致）
      - ./models/huggingface:/models/huggingface
    environment:
      - LOG_LEVEL=info
      - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
      - HF_HOME=/models/huggingface
      - TRANSFORMERS_CACHE=/models/huggingface  # Transformers 缓存目录
      - TORCH_HOME=/models/huggingface  # PyTorch 缓存目录
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G
    networks:
      - aidg-network
    restart: unless-stopped

  # Main AIDG service
  aidg:
    build:
      context: .
      dockerfile: Dockerfile.lite
    image: aidg-aidg:lite-test
    container_name: aidg-unified
    environment:
      # 依赖服务配置（符合 task_1760229132 设计）
      - DEPENDENCY_MODE=remote
      - DEPS_SERVICE_URL=http://aidg-deps-service:8080
      - DEPENDENCY_SHARED_VOLUME=/app/data
      # Whisper 配置
      - WHISPER_API_URL=http://aidg-whisper:80
      - WHISPER_MODE=go-whisper  # 默认使用独立whisper服务，修改为"cli"可切换到本地CLI模式
      # 音频处理配置（通过依赖服务）
      - ENABLE_AUDIO_CONVERSION=true
      - ENABLE_SPEAKER_DIARIZATION=true
      - ENABLE_DEGRADATION=true
      - ENABLE_OFFLINE=false  # 禁用离线模式，允许 PyAnnote 下载模型
      # 基础配置
      - ENV=production
      - PORT=8000
      - MCP_HTTP_PORT=8081
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      # JWT 配置
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-me-in-production-at-least-32-chars}
      - USER_JWT_SECRET=${USER_JWT_SECRET:-dev-user-jwt-secret-at-least-32-chars}
      - ADMIN_DEFAULT_PASSWORD=${ADMIN_DEFAULT_PASSWORD:-admin123}
      # MCP 配置
      - MCP_PASSWORD=${MCP_PASSWORD:-dev-mcp-password}
      # 数据目录
      - PROJECTS_DIR=/app/data/projects
      - USERS_DIR=/app/data/users
      - MEETINGS_DIR=/app/data/meetings
      - AUDIT_LOGS_DIR=/app/data/audit_logs
      # CORS 配置
      - CORS_ALLOWED_ORIGINS=http://localhost:8000,http://localhost:3000
    volumes:
      - ./data/projects:/app/data/projects
      - ./data/users:/app/data/users
      - ./data/meetings:/app/data/meetings
      - ./data/audit_logs:/app/data/audit_logs
      - ./data:/data
      - ./models:/models:ro
    ports:
      - "8000:8000"
      - "8081:8081"
    depends_on:
      whisper:
        condition: service_started
      deps-service:
        condition: service_healthy
    networks:
      - aidg-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  aidg-network:
    driver: bridge
