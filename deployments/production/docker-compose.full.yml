# 生产部署 - Full 方案
# 用途：生产环境，需要全部功能包括语义搜索
# 包含：主服务 + deps-service + whisper + nlp_service
# 镜像来源：ghcr.io/houzhh15

services:
  # 语音转录服务（第三方镜像）
  whisper:
    image: ghcr.io/mutablelogic/go-whisper:latest
    container_name: aidg-whisper
    command: ["run", "--http.addr", "0.0.0.0:80"]
    expose:
      - "80"
    volumes:
      - ../../models/whisper:/data
      - ../../data/meetings:/output
    networks:
      - aidg-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 6G
        reservations:
          cpus: '1'
          memory: 3G

  # 依赖执行服务（GHCR 镜像）
  deps-service:
    image: ghcr.io/houzhh15/aidg-deps:${IMAGE_TAG:-latest}
    container_name: aidg-deps-service
    expose:
      - "8080"
    volumes:
      - ../../data:/app/data
      - ../../config:/app/config:ro
      - ../../models/huggingface:/models/huggingface
    environment:
      - LOG_LEVEL=info
      - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
      # HF_HUB_CACHE 是 PyAnnote 模型的唯一必需环境变量
      - HF_HUB_CACHE=/models/huggingface/hub
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - aidg-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 4G

  # NLP 服务（GHCR 镜像）- 仅内部访问
  nlp-service:
    image: ghcr.io/houzhh15/aidg-nlp:${IMAGE_TAG:-latest}
    container_name: aidg-nlp
    expose:
      - "5001"
    volumes:
      - ../../models/huggingface:/root/.cache/huggingface:ro
    healthcheck:
      test: ["CMD", "python", "-c", 
             "import requests; requests.get('http://localhost:5001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - aidg-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # 主服务（GHCR 镜像）
  aidg:
    image: ghcr.io/houzhh15/aidg:${IMAGE_TAG:-latest}
    container_name: aidg-unified
    ports:
      - "8000:8000"
      - "8001:8001"
    environment:
      - ENV=production
      - PORT=8000
      - MCP_HTTP_PORT=8001
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      # 依赖服务配置
      - DEPENDENCY_MODE=remote
      - DEPS_SERVICE_URL=http://aidg-deps-service:8080
      - DEPENDENCY_SHARED_VOLUME=/app/data
      # Whisper 配置
      - WHISPER_MODE=go-whisper
      - WHISPER_API_URL=http://aidg-whisper:80
      # NLP 配置（内部服务）
      - NLP_SERVICE_URL=http://aidg-nlp:5001
      - ENABLE_SEMANTIC_SEARCH=true
      # 音频处理配置
      - ENABLE_AUDIO_CONVERSION=true
      - ENABLE_SPEAKER_DIARIZATION=true
      - ENABLE_DEGRADATION=true
      - ENABLE_OFFLINE=false
      # 安全配置
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-me-in-production-at-least-32-chars}
      - USER_JWT_SECRET=${USER_JWT_SECRET:-dev-user-jwt-secret-at-least-32-chars}
      - IDP_ENCRYPTION_KEY=${IDP_ENCRYPTION_KEY:-change-this-to-32-char-secret-key}
      - ADMIN_DEFAULT_PASSWORD=${ADMIN_DEFAULT_PASSWORD:-admin123}
      - MCP_PASSWORD=${MCP_PASSWORD:-dev-mcp-password}
      # 数据目录
      - PROJECTS_DIR=/app/data/projects
      - USERS_DIR=/app/data/users
      - MEETINGS_DIR=/app/data/meetings
      - AUDIT_LOGS_DIR=/app/data/audit_logs
      # MCP 与 CORS 配置
      - MCP_SERVER_URL=${MCP_SERVER_URL:-http://localhost:8000}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:8000,http://localhost:3000}
    volumes:
      - ../../data/projects:/app/data/projects
      - ../../data/users:/app/data/users
      - ../../data/meetings:/app/data/meetings
      - ../../data/audit_logs:/app/data/audit_logs
      - ../../data:/data
      - ../../models:/models:ro
    depends_on:
      whisper:
        condition: service_started
      deps-service:
        condition: service_healthy
      nlp-service:
        condition: service_healthy
    networks:
      - aidg-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", 
             "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  aidg-network:
    driver: bridge
