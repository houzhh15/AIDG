# 本地构建 - Standard 部署方案
# 用途：本地开发、CI 前测试
# 包含：主服务 + deps-service + whisper
# 镜像来源：本地构建

services:
  # 语音转录服务（第三方镜像）
  whisper:
    image: ghcr.io/mutablelogic/go-whisper:latest
    container_name: aidg-whisper-local
    command: ["run", "--http.addr", "0.0.0.0:80"]
    expose:
      - "80"
    volumes:
      - ../../models/whisper:/data
      - ../../data/meetings:/output
    networks:
      - aidg-local-network
    restart: unless-stopped

  # 依赖执行服务（本地构建）
  deps-service:
    build:
      context: ../..
      dockerfile: build/dockerfiles/Dockerfile.deps
    image: aidg-deps:local
    container_name: aidg-deps-local
    expose:
      - "8080"
    volumes:
      - ../../data:/app/data
      - ../../config:/app/config:ro
      - ../../models/huggingface:/models/huggingface
    environment:
      - LOG_LEVEL=info
      - HUGGINGFACE_TOKEN=${HUGGINGFACE_TOKEN}
      # HF_HUB_CACHE 是 PyAnnote 模型的唯一必需环境变量
      - HF_HUB_CACHE=/models/huggingface/hub
      # 离线模式：使用本地缓存的模型，不访问网络
      - HF_HUB_OFFLINE=1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - aidg-local-network
    restart: unless-stopped

  # 主服务（本地构建）
  aidg:
    build:
      context: ../..
      dockerfile: build/dockerfiles/Dockerfile
    image: aidg:local
    container_name: aidg-local
    ports:
      - "8000:8000"
      - "8001:8001"
    environment:
      - ENV=development
      - PORT=8000
      - MCP_HTTP_PORT=8001
      - LOG_LEVEL=debug
      - LOG_FORMAT=console
      # 依赖服务配置
      - DEPENDENCY_MODE=remote
      - DEPS_SERVICE_URL=http://aidg-deps-local:8080
      - DEPENDENCY_SHARED_VOLUME=/app/data
      # Whisper 配置
      - WHISPER_MODE=go-whisper
      - WHISPER_API_URL=http://aidg-whisper-local:80
      # 音频处理配置
      - ENABLE_AUDIO_CONVERSION=true
      - ENABLE_SPEAKER_DIARIZATION=true
      - ENABLE_DEGRADATION=true
      - ENABLE_OFFLINE=false
      # 安全配置（开发环境）
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-me-in-production-at-least-32-chars}
      - USER_JWT_SECRET=${USER_JWT_SECRET:-dev-user-jwt-secret-at-least-32-chars}
      - IDP_ENCRYPTION_KEY=${IDP_ENCRYPTION_KEY:-change-this-to-32-char-secret-key}
      - ADMIN_DEFAULT_PASSWORD=${ADMIN_DEFAULT_PASSWORD:-admin123}
      - MCP_PASSWORD=${MCP_PASSWORD:-dev-mcp-password}
      # 数据目录
      - PROJECTS_DIR=/app/data/projects
      - USERS_DIR=/app/data/users
      - MEETINGS_DIR=/app/data/meetings
      - AUDIT_LOGS_DIR=/app/data/audit_logs
      # MCP 与 CORS 配置
      - MCP_SERVER_URL=${MCP_SERVER_URL:-http://localhost:8000}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:5173,http://localhost:8000}
    volumes:
      - ../../data:/app/data
      - ../../config:/app/config:ro
      - ../../models:/models:ro
    depends_on:
      whisper:
        condition: service_started
      deps-service:
        condition: service_healthy
    networks:
      - aidg-local-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", 
             "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  aidg-local-network:
    driver: bridge
