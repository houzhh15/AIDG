# 本地构建 - Lite 部署方案
# 用途：本地开发、快速测试
# 包含：仅主服务（server + mcp-server + file_converter）
# 镜像来源：本地构建

services:
  aidg:
    build:
      context: ../..
      dockerfile: build/dockerfiles/Dockerfile
    image: aidg:local
    container_name: aidg-lite-local
    ports:
      - "8000:8000"
      - "8001:8001"
    environment:
      - ENV=development
      - PORT=8000
      - MCP_HTTP_PORT=8001
      - LOG_LEVEL=debug
      - LOG_FORMAT=console
      # 禁用外部依赖
      - DEPENDENCY_MODE=disabled
      - WHISPER_MODE=disabled
      - ENABLE_AUDIO_CONVERSION=false
      - ENABLE_SPEAKER_DIARIZATION=false
      # 安全配置（开发环境）
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-me-in-production-at-least-32-chars}
      - USER_JWT_SECRET=${USER_JWT_SECRET:-dev-user-jwt-secret-at-least-32-chars}
      - IDP_ENCRYPTION_KEY=${IDP_ENCRYPTION_KEY:-change-this-to-32-char-secret-key}
      - ADMIN_DEFAULT_PASSWORD=${ADMIN_DEFAULT_PASSWORD:-admin123}
      - MCP_PASSWORD=${MCP_PASSWORD:-dev-mcp-password}
      # 数据目录
      - PROJECTS_DIR=/app/data/projects
      - USERS_DIR=/app/data/users
      - MEETINGS_DIR=/app/data/meetings
      - AUDIT_LOGS_DIR=/app/data/audit_logs
      # MCP 与 CORS 配置
      - MCP_SERVER_URL=${MCP_SERVER_URL:-http://localhost:8000}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:5173,http://localhost:8000}
    volumes:
      - ../../data/projects:/app/data/projects
      - ../../data/users:/app/data/users
      - ../../data/meetings:/app/data/meetings
      - ../../data/audit_logs:/app/data/audit_logs
      - ../../models/tessdata:/usr/share/tessdata:ro
      - ../../config:/app/config:ro
    networks:
      - aidg-local-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", 
             "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  aidg-local-network:
    driver: bridge
